<div class="create-posts-container">
    <div class="glass-panel">
        <span class="badge">New Post</span>

        <div class="header-section">
            <h1 class="page-title">Create Post</h1>
            <p class="page-subtitle">Share a pet in need with the community.</p>
        </div>

        <form [formGroup]="postForm" (ngSubmit)="onSubmit()" class="post-form">
            <!-- Top Controls: Category & Action -->
            <div class="form-grid top-controls">
                <div class="input-group">
                    <label>What's the pet?</label>
                    <div class="custom-select-wrapper" [class.active]="activeDropdown === 'category'">
                        <div class="select-trigger" (click)="toggleDropdown($event, 'category')">
                            <i class="material-icons">pets</i>
                            <span>{{ getDisplayValue('category') }}</span>
                            <i class="material-icons arrow">expand_more</i>
                        </div>
                        <div class="select-options" *ngIf="activeDropdown === 'category'">
                            <div class="option" [class.selected]="postForm.value.category === 'dog'"
                                (click)="selectOption('category', 'dog')">Dog / Puppy</div>
                            <div class="option" [class.selected]="postForm.value.category === 'cat'"
                                (click)="selectOption('category', 'cat')">Cat / Kitten</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Post Topic</label>
                    <div class="custom-select-wrapper" [class.active]="activeDropdown === 'action'">
                        <div class="select-trigger" (click)="toggleDropdown($event, 'action')">
                            <i class="material-icons">campaign</i>
                            <span>{{ getDisplayValue('action') }}</span>
                            <i class="material-icons arrow">expand_more</i>
                        </div>
                        <div class="select-options" *ngIf="activeDropdown === 'action'">
                            <div class="option" [class.selected]="postForm.value.action === 'adoption'"
                                (click)="selectOption('action', 'adoption')">For Adoption</div>
                            <div class="option" [class.selected]="postForm.value.action === 'missing'"
                                (click)="selectOption('action', 'missing')">Missing Pet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Upload Area -->
            <div class="upload-section">
                <div class="upload-container">
                    <div class="upload-placeholder" *ngIf="previewUrls.length === 0" (click)="fileInput.click()"
                        style="cursor: pointer;">
                        <i class="material-icons">cloud_upload</i>
                        <span>Click to upload photos</span>
                        <p class="upload-hint">Up to 6 images (JPG, PNG)</p>
                    </div>

                    <div class="preview-grid" *ngIf="previewUrls.length > 0">
                        <!-- Processing Overlay -->
                        <div class="processing-overlay" *ngIf="isProcessing">
                            <span class="loader small"></span>
                            <span>Optimizing...</span>
                        </div>

                        <div class="preview-item" *ngFor="let url of previewUrls; let i = index" draggable="true"
                            [attr.data-index]="i" [class.dragging]="draggedIndex === i || touchStartIndex === i"
                            (dragstart)="onDragStart(i)" (dragover)="onDragOver($event, i)" (drop)="onDrop($event, i)"
                            (touchstart)="onTouchStart(i, $event)" (touchmove)="onTouchMove($event)"
                            (touchend)="onTouchEnd()">
                            <img [src]="url" alt="Preview">
                            <div class="preview-overlay">
                                <div class="drag-handle">
                                    <i class="material-icons">drag_indicator</i>
                                </div>
                                <button type="button" class="remove-btn"
                                    (click)="$event.stopPropagation(); removeFile(i)">
                                    <i class="material-icons">close</i>
                                </button>
                            </div>
                        </div>
                        <div class="add-more-item" (click)="previewUrls.length < 6 && fileInput.click()"
                            *ngIf="previewUrls.length < 6">
                            <i class="material-icons">add</i>
                        </div>
                    </div>
                    <div class="drag-prompt" *ngIf="previewUrls.length > 0 && !isProcessing">
                        <i class="material-icons">info</i>
                        <span>{{ previewUrls.length > 1 ? 'Drag to rearrange â€¢ ' : '' }}Aspect ratio: {{
                            selectedAspectRatio === 1.91 ? 'Landscape' :
                            selectedAspectRatio === 0.8 ? 'Portrait' : 'Square' }}</span>
                    </div>
                </div>
                <input #fileInput id="fileInput" type="file" multiple (change)="onFileSelected($event)" accept="image/*"
                    style="display: none;">
            </div>

            <!-- Contact & Format Section -->
            <div class="form-grid">
                <div class="input-group">
                    <label>Contact Number (Optional)</label>
                    <div class="input-with-icon">
                        <i class="material-icons">phone</i>
                        <input type="tel" formControlName="phone" placeholder="10-digit number" maxlength="10">
                    </div>
                    <label class="custom-checkbox instagram-toggle">
                        <input type="checkbox" formControlName="useInstagram">
                        <span class="checkbox-label">Use my Instagram username to contact</span>
                    </label>
                </div>
                <div class="input-group">
                    <label>Post Format</label>
                    <div class="custom-select-wrapper" [class.active]="activeDropdown === 'type'">
                        <div class="select-trigger" (click)="toggleDropdown($event, 'type')">
                            <i class="material-icons">layers</i>
                            <span>{{ getDisplayValue('type') }}</span>
                            <i class="material-icons arrow">expand_more</i>
                        </div>
                        <div class="select-options" *ngIf="activeDropdown === 'type'">
                            <div class="option" [class.selected]="postForm.value.type === 'post'"
                                (click)="selectOption('type', 'post')">Post</div>
                            <div class="option disabled">Reel (Coming Soon)</div>
                            <div class="option disabled">Story (Coming Soon)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Section -->
            <div class="form-grid location-section">
                <div class="input-group">
                    <label>Area / Neighborhood</label>
                    <div class="input-with-icon">
                        <i class="material-icons">location_on</i>
                        <input type="text" formControlName="locationDetail" placeholder="e.g. Peelamedu">
                    </div>
                </div>
                <div class="input-group">
                    <label>City / District</label>
                    <div class="city-selector-container">
                        <div class="custom-select-wrapper city-select" [class.active]="activeDropdown === 'city'">
                            <div class="select-trigger" (click)="toggleDropdown($event, 'city')">
                                <span>{{ postForm.value.city }}</span>
                                <i class="material-icons arrow">expand_more</i>
                            </div>
                            <div class="select-options scrollable" *ngIf="activeDropdown === 'city'">
                                <div class="option" *ngFor="let district of districts"
                                    [class.selected]="postForm.value.city === district"
                                    (click)="selectOption('city', district)">
                                    {{ district }}
                                </div>
                            </div>
                        </div>
                        <span class="state-suffix">Tamil Nadu</span>
                    </div>
                </div>
            </div>



            <!-- Caption & Hashtags -->
            <div class="form-grid">
                <div class="input-group full-width">
                    <label>Share your message (Optional)</label>
                    <textarea formControlName="userCaption" placeholder="Describe the pet, age, etc..." rows="2"
                        style="resize: none; height: 80px;"></textarea>
                </div>

                <div class="hashtags-display full-width">
                    <label>Hashtags</label>
                    <div class="hashtags-content">
                        {{ dynamicHashtags }}
                    </div>
                </div>
            </div>

            <div class="cta-container">
                <div class="validation-warning" *ngIf="postForm.errors?.['contactRequired']">
                    <i class="material-icons">info</i> Please provide a contact number or use your Instagram username.
                </div>
                <button type="submit" class="upload-button"
                    [disabled]="postForm.invalid || previewUrls.length === 0 || isUploading">
                    <i class="material-icons" *ngIf="!isUploading">send</i>
                    <span class="loader" *ngIf="isUploading"></span>
                    <span>{{ isUploading ? 'Uploading...' : 'Preview & Upload' }}</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Instagram Preview Modal -->
    <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="insta-post-preview">
                <div class="insta-header">
                    <div class="insta-user">
                        <img src="/cbe_adoption_circle.png" class="insta-avatar-img" alt="User Avatar">
                        <div class="insta-user-info">
                            <span class="insta-username">coimbatore_pet_adoption</span>
                            <span class="insta-location" *ngIf="postForm.value.city">{{ postForm.value.city }}, Tamil
                                Nadu</span>
                        </div>
                    </div>
                </div>

                <div class="insta-media" *ngIf="previewUrls.length > 0" [style.aspect-ratio]="selectedAspectRatio">
                    <div class="carousel-container">
                        <button class="nav-btn prev" *ngIf="previewUrls.length > 1" (click)="prevMedia()">
                            <i class="material-icons">chevron_left</i>
                        </button>

                        <img [src]="previewUrls[currentPreviewIndex]" alt="Preview" style="object-fit: cover;">

                        <button class="nav-btn next" *ngIf="previewUrls.length > 1" (click)="nextMedia()">
                            <i class="material-icons">chevron_right</i>
                        </button>

                        <div class="carousel-dots" *ngIf="previewUrls.length > 1">
                            <span *ngFor="let p of previewUrls; let i = index"
                                [class.active]="i === currentPreviewIndex"></span>
                        </div>
                    </div>
                </div>


                <div class="insta-caption-area">
                    <div class="insta-caption-content">
                        <strong>coimbatore_pet_adoption</strong>
                        <pre class="formatted-caption">{{ generatedFullCaption }}</pre>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <p class="warning-text">
                    <i class="material-icons">warning</i>
                    Details cannot be changed after upload.
                </p>
                <div class="modal-buttons">
                    <button class="cancel-btn" (click)="closeModal()">Edit</button>
                    <button class="confirm-btn" (click)="confirmUpload()">Confirm & Upload</button>
                </div>
            </div>
        </div>
    </div>
</div>